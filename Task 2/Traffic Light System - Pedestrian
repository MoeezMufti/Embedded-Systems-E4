#include <Wire.h>

// Pin definitions
const int greenLight = 6;
const int yellowLight = 5;
const int redLight = 4;
const int pedRed = 7;
const int pedGreen = 8;
const int button = 2;  // interrupt-capable

volatile bool buttonPressed = false; // Flag set by interrupt
unsigned long previousMs = 0;
unsigned long greenDuration = 10000; // Normal green duration = 10s
unsigned long yellowDuration = 5000; // Yellow = 5s
unsigned long redDuration = 0;       // Managed dynamically

enum TrafficState { Green, Yellow, Red };
TrafficState currentState = Green;

void setup() {
  pinMode(greenLight, OUTPUT);
  pinMode(yellowLight, OUTPUT);
  pinMode(redLight, OUTPUT);
  pinMode(pedRed, OUTPUT);
  pinMode(pedGreen, OUTPUT);
  pinMode(button, INPUT_PULLUP);

  attachInterrupt(digitalPinToInterrupt(button), buttonISR, FALLING);

  // Start with traffic green and pedestrian red
  digitalWrite(greenLight, HIGH);
  digitalWrite(pedRed, HIGH);
  previousMs = millis();
}

void loop() {
  unsigned long now = millis();

  switch (currentState) {
    case Green:
      // If button pressed, switch to yellow early (within 3 seconds)
      if (buttonPressed && (now - previousMs >= 3000)) {
        exitGreen();
        enterYellow();
      }
      // If no button pressed, normal 10s green duration
      else if (!buttonPressed && (now - previousMs >= greenDuration)) {
        exitGreen();
        enterYellow();
      }
      break;

    case Yellow:
      if (now - previousMs >= yellowDuration) {
        exitYellow();
        enterRed();
      }
      break;

    case Red:
      if (now - previousMs >= redDuration) {
        exitRed();
        enterGreen();
      }
      break;
  }
}

// ======== STATE TRANSITION FUNCTIONS ========

void enterGreen() {
  digitalWrite(greenLight, HIGH);
  digitalWrite(yellowLight, LOW);
  digitalWrite(redLight, LOW);

  digitalWrite(pedGreen, LOW);
  digitalWrite(pedRed, HIGH);

  currentState = Green;
  previousMs = millis();
}

void exitGreen() {
  digitalWrite(greenLight, LOW);
}

void enterYellow() {
  digitalWrite(yellowLight, HIGH);
  currentState = Yellow;
  previousMs = millis();
}

void exitYellow() {
  digitalWrite(yellowLight, LOW);
}

void enterRed() {
  digitalWrite(redLight, HIGH);
  currentState = Red;
  previousMs = millis();

  // Pedestrian sequence
  digitalWrite(pedRed, LOW);
  delay(2000);               // Wait before allowing pedestrians
  digitalWrite(pedGreen, HIGH);
  delay(5000);               // Pedestrian green duration

  // Reset pedestrian lights
  digitalWrite(pedGreen, LOW);
  digitalWrite(pedRed, HIGH);

  redDuration = 1000; // short pause before returning to green
}

void exitRed() {
  digitalWrite(redLight, LOW);
  buttonPressed = false; // Reset button flag
}

void buttonISR() {
  buttonPressed = true;
}
